// Generated by CoffeeScript 1.8.0
$(function() {
  var $grid, $iframe, $searchForm, $searchInput, $tabs, DEFAULT_INTERVAL, clearGrid, gridRowTmpl, onDblClickRow, onDelete, rewriteRows, search;
  $tabs = $('#tabs');
  $grid = $('#grid');
  $searchInput = $('#search_input');
  $iframe = $('#async_load_frame');
  $searchForm = $('#search_panel');
  gridRowTmpl = '<tr data-doc_id="{{ doc_id }}" data-filename="{{ filename }}">\n<td class="column_no">{{ no }}</td>\n<td class="column_filename">{{ filename }}</td>\n<td class="column_size">{{ size }}</td>\n<td class="column_type">{{ content_type }}</td>\n<td class="column_created">{{ created }}</td>\n<td class="column_edit"><span class="btn btn-default glyphicon glyphicon-minus-sign" alt="削除"></span></td>\n</tr>';
  DEFAULT_INTERVAL = 10;
  search = function(query) {
    var _query, _url;
    _url = '/list/search';
    if (query) {
      _url += "/" + query;
    }
    _query = [];
    if (_query.length > 0) {
      _url += concreteQuery(_query);
    }
    return $.getJSON(_url, {}, function(json) {
      return rewriteRows(json);
    });
  };
  clearGrid = function() {
    return $grid.find('tbody>tr').off().remove();
  };
  rewriteRows = function(json) {
    var i;
    clearGrid();
    i = 0;
    return _.each(json, function(o) {
      var $tbdy;
      $tbdy = $grid.find('tbody');
      return (function(_o, _i) {
        return setTimeout(function() {
          return $tbdy.append(_.template(gridRowTmpl, _o));
        }, DEFAULT_INTERVAL * _i);
      })(o, i++);
    });
  };
  onDelete = function(e) {
    var docId, filename;
    docId = $(e.currentTarget).closest("tr").data('doc_id');
    filename = $(e.currentTarget).closest("tr").data('filename');
    if (window.confirm("ファイル「" + filename + "」を削除します．よろしいですか．")) {
      return $.ajax({
        type: 'POST',
        url: "/list/" + docId,
        data: {
          _method: 'DELETE'
        }
      }).always(function() {
        return search();
      });
    }
  };
  onDblClickRow = function(e) {
    var dblClicked, _form, _iframe, _interval;
    dblClicked = $(e.currentTarget).data('doc_id');
    _iframe = document.createElement("iframe");
    _iframe.name = "hidden_frame";
    _iframe.style.display = "none";
    document.body.appendChild(_iframe);
    _form = document.createElement('form');
    _form.name = "hidden_form";
    _form.action = "/download/" + dblClicked;
    _form.target = _iframe.name;
    _form.style.display = "none";
    document.body.appendChild(_form);
    $.cookie("loading", '1');
    _form.submit();
    document.body.removeChild(_form);
    daycrift.view.loadingDialog();
    return _interval = setInterval(function() {
      var _cookie;
      _cookie = $.cookie('loading');
      if (_cookie === '1') {
        $.cookie('loading', '0');
        daycrift.view.loadingDialog('remove');
        return clearInterval(_interval);
      }
    }, 50);
  };
  $searchForm.on('submit', function(e) {
    return false;
  });
  $searchInput.on('change', function(e) {
    var _input;
    _input = $(e.target);
    return search(_input.val());
  });
  $iframe.on('load', function() {
    console.log("start reload.");
    return search();
  });
  $grid.on('dblclick', 'tr', onDblClickRow).on('click', 'tr .glyphicon-minus-sign', onDelete);
  return search();
});
